<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supabase 接入 Google 登录完整流程（CSR 版本）</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans", "PingFang TC", "Microsoft JhengHei", sans-serif;
      line-height: 1.6;
      margin: 24px;
      max-width: 900px;
    }

    h1 {
      font-size: 24px;
      margin: 0 0 12px;
    }

    h2 {
      font-size: 18px;
      margin-top: 28px;
    }

    h3 {
      font-size: 16px;
      margin-top: 18px;
    }

    code,
    pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    pre {
      padding: 12px;
      border-radius: 8px;
      overflow: auto;
      background: rgba(127, 127, 127, .12);
    }

    .note {
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(127, 127, 127, .12);
    }

    ul {
      margin: 8px 0 8px 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
    }

    th,
    td {
      border: 1px solid rgba(127, 127, 127, .35);
      padding: 8px;
      text-align: left;
    }
  </style>
</head>

<body>
  <h1>Supabase 接入 Google 登录完整流程（CSR 版本）</h1>

  <div class="note">
    <strong>适用场景</strong>
    <ul>
      <li>Next.js App Router</li>
      <li>纯前端调用 Supabase</li>
      <li>不使用 SSR</li>
      <li>登录后回当前页</li>
    </ul>
  </div>

  <h2>一、准备条件</h2>
  <ul>
    <li>一个 Supabase 项目</li>
    <li>一个 Google Cloud 项目</li>
    <li>本地开发地址：<code>http://localhost:3000</code></li>
  </ul>

  <h2>二、Supabase 端配置</h2>

  <h3>1. 配置跳转白名单</h3>
  <p>进入：<code>Supabase Dashboard → Authentication → URL Configuration</code></p>
  <p><strong>Site URL</strong>：<code>http://localhost:3000</code></p>
  <p><strong>Redirect URLs</strong>：添加 <code>http://localhost:3000/**</code></p>
  <p class="note">⚠️ 必须添加，否则 OAuth 回跳会报错。</p>

  <h3>2. 开启 Google Provider</h3>
  <p>进入：<code>Authentication → Providers → Google</code></p>
  <p>记录页面里的 <strong>Callback URL</strong>，例如：</p>
  <pre><code>https://xxxx.supabase.co/auth/v1/callback</code></pre>
  <p class="note">⚠️ 该 URL 需要填入 Google Cloud。</p>
  <p>保持以下选项关闭：<code>Skip nonce checks</code>、<code>Allow users without an email</code></p>

  <h2>三、Google Cloud 配置</h2>

  <h3>1. 配置 OAuth Consent Screen</h3>
  <p>进入：<code>Google Cloud Console → APIs &amp; Services → OAuth consent screen</code></p>
  <ul>
    <li>选择 External</li>
    <li>填写应用名称</li>
    <li>添加测试邮箱</li>
  </ul>

  <h3>2. 创建 OAuth Client</h3>
  <p>进入：<code>APIs &amp; Services → Credentials → Create Credentials → OAuth client ID</code></p>
  <p><strong>Application Type</strong>：Web Application</p>
  <p><strong>Authorized JavaScript origins</strong>：</p>
  <pre><code>http://localhost:3000</code></pre>
  <p><strong>Authorized redirect URIs</strong>：填写 Supabase 的 Callback URL：</p>
  <pre><code>https://xxxx.supabase.co/auth/v1/callback</code></pre>
  <p>保存后获得：<strong>Client ID</strong> / <strong>Client Secret</strong></p>

  <h2>四、回到 Supabase 填入凭证</h2>
  <p>进入：<code>Authentication → Providers → Google</code></p>
  <ul>
    <li>填入 Client ID</li>
    <li>填入 Client Secret</li>
    <li>保存</li>
  </ul>

  <h2>五、前端接入（Next.js CSR）</h2>

  <h3>1. 登录函数</h3>
  <pre><code>const handleLogin = async () =&gt; {
  await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: window.location.href }
  })
}</code></pre>

  <h3>2. 监听用户状态</h3>
  <pre><code>useEffect(() =&gt; {
  supabase.auth.getSession().then(({ data }) =&gt; {
    setUser(data.session?.user ?? null)
  })

  const { data: listener } = supabase.auth.onAuthStateChange(
    (_event, session) =&gt; {
      setUser(session?.user ?? null)
    }
  )

  return () =&gt; listener.subscription.unsubscribe()
}, [])</code></pre>

  <h3>3. 登出</h3>
  <pre><code>const handleLogout = async () =&gt; {
  await supabase.auth.signOut()
}</code></pre>

  <h2>六、完整流程</h2>
  <pre><code>未登录
↓
点击登录
↓
跳转 Google
↓
用户选择账号
↓
Google 回跳 Supabase
↓
Supabase 创建 session
↓
回到当前页
↓
onAuthStateChange 触发
↓
setUser 更新
↓
头像显示</code></pre>

  <h2>七、常见错误</h2>
  <h3>1) redirect_uri_mismatch</h3>
  <p>原因：Google Cloud 的 redirect URI 填错。必须是 Supabase 的：</p>
  <pre><code>https://xxxx.supabase.co/auth/v1/callback</code></pre>

  <h3>2) 登录后报错</h3>
  <p>原因：Supabase 的 Redirect URLs 未添加：</p>
  <pre><code>http://localhost:3000/**</code></pre>

  <h2>八、是否需要 callback 页面？</h2>
  <p>在 <strong>CSR + 前端直连 Supabase</strong> 架构下，不需要 callback 页面 / exchangeCodeForSession / 额外 API；SSR / middleware
    场景才需要。</p>

  <h2>九、最终架构总结</h2>
  <table>
    <thead>
      <tr>
        <th>项目</th>
        <th>状态</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Google 登录</td>
        <td>已接入</td>
      </tr>
      <tr>
        <td>回当前页</td>
        <td>已实现</td>
      </tr>
      <tr>
        <td>自动切换头像</td>
        <td>已实现</td>
      </tr>
      <tr>
        <td>自动登出更新</td>
        <td>已实现</td>
      </tr>
      <tr>
        <td>无刷新更新</td>
        <td>已实现</td>
      </tr>
    </tbody>
  </table>

  <p class="note">建议把此文件路径固定为：<code>/public/docs/google-oauth.html</code>，团队里谁都能直接访问。</p>
</body>

</html>